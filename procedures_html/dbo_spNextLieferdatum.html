<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dbo.spNextLieferdatum</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; }
        h1 { color: #333; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>dbo.spNextLieferdatum</h1>
    <p><strong>Description:</strong> Mit der Stored procedure kann das nächste Lieferdatum eines Artikels berechnet werden. Dabei werden sich bereits im Zulauf befindliche Artikel die schon reserviert sind ausgenommen.</p>
    <p><strong>Long Description:</strong> Keine ausführliche Beschreibung hinterlegt.</p>
    <p><strong>Created At:</strong> 2024-01-12 03:32:03</p>
    <p><strong>Updated At:</strong> 2024-01-12 03:32:03</p>
    <h2>Code:</h2>
    <pre><code>CREATE PROCEDURE [dbo].[spNextLieferdatum]
    @typeArtikel TYPE_spNextLieferdatum READONLY

AS
SET NOCOUNT ON;
SET ANSI_NULLS ON;
SET ANSI_NULL_DFLT_ON ON;
SET ANSI_PADDING ON;
SET CONCAT_NULL_YIELDS_NULL ON;
SET XACT_ABORT OFF;
DECLARE @retry INT = 5;
WHILE @retry &gt; 0
BEGIN    
    IF(object_id(&#39;tempdb..#TempResult&#39;) IS NOT NULL)
    BEGIN
	  DROP TABLE #TempResult
    END
    DECLARE @Artikel TABLE(kArtikel INT, dLieferdatum DATETIME);
    INSERT INTO @Artikel(kArtikel)
	SELECT kArtikel
	FROM @typeArtikel

    DECLARE @dLieferdatum DATETIME;

    SELECT Artikel.kArtikel, (POS.fMenge - POS.fMengeGeliefert) AS MengeOffen, POS.dLieferdatum, 
		  RANK() OVER(PARTITION BY POS.kArtikel ORDER BY POS.dLieferdatum) AS Rang
		  INTO #TempResult
	   FROM tLieferantenbestellungPos AS POS
	   JOIN tLieferantenbestellung ON POS.kLieferantenBestellung = tLieferantenbestellung.kLieferantenBestellung
	   JOIN @Artikel AS Artikel ON POS.kArtikel = Artikel.kArtikel
	   WHERE nStatus &lt; 100 AND nStatus &gt;= 5 AND (POS.fMenge - POS.fMengeGeliefert) &gt; 0.0
    --
    -- Kein Fifo aktiv
    --
    IF(ISNULL((SELECT CONVERT(BIT, ISNULL(cValue, 0)) FROM toptions WITH(NOLOCK) WHERE cKey = &#39;FiFoAuftragsReservierung&#39;), 0) = 0)
    BEGIN
	   UPDATE #TempResult SET dLieferdatum = Result.Lieferdatum	      
	   FROM #TempResult
	   JOIN 
	   (
		  SELECT  a.kArtikel, ISNULL(a.dLieferdatum,0) AS Lieferdatum,
				(SELECT SUM(ISNULL(b.MengeOffen,0.0)) 
				    FROM #TempResult AS b 
				    WHERE b.Rang &lt;= a.Rang AND b.kArtikel = a.kArtikel
				) AS LaufendeSumme,
				SUM(vAuftragPositionEckdaten.fAnzahlOffen) AS SummeRes
			 FROM #TempResult AS a
			 JOIN Verkauf.vAuftragPosition ON vAuftragPosition.kArtikel = a.kArtikel
			 JOIN Verkauf.vAuftragPositionEckdaten ON vAuftragPositionEckdaten.kAuftragPosition = vAuftragPosition.kAuftragPosition
			 GROUP BY a.kArtikel, a.dLieferdatum, a.Rang
			 HAVING SUM(vAuftragPositionEckdaten.fAnzahlOffen) &gt;= 0
	   ) AS Result ON #TempResult.kArtikel = Result.kArtikel
	   WHERE SummeRes &lt; LaufendeSumme
    END
    ELSE
    BEGIN
	   --
	   -- Fifo aktiv
	   --
	   UPDATE #TempResult SET dLieferdatum = Result.Lieferdatum	      
	   FROM #TempResult
	   JOIN 
	   (
		  SELECT  vAuftragPosition.kArtikel, ISNULL(a.dLieferdatum,0) AS Lieferdatum,
				(SELECT SUM(b.MengeOffen) 
				    FROM #TempResult AS b 
				    WHERE b.Rang &lt;= a.Rang AND b.kArtikel = a.kArtikel
				) AS LaufendeSumme,
				SUM(vAuftragPositionEckdaten.fAnzahlOffen) AS SummeRes
			 FROM #TempResult AS a
			 JOIN Verkauf.vAuftragPosition ON vAuftragPosition.kArtikel = a.kArtikel
			 JOIN Verkauf.vAuftragPositionEckdaten ON vAuftragPositionEckdaten.kAuftragPosition = vAuftragPosition.kAuftragPosition
			 GROUP BY a.kArtikel, vAuftragPosition.kArtikel, a.dLieferdatum, a.Rang
			 HAVING SUM(vAuftragPositionEckdaten.fAnzahlOffen) &gt;= 0
	   ) AS Result ON #TempResult.kArtikel = Result.kArtikel
	   WHERE Result.SummeRes &lt; Result.LaufendeSumme
    END
    BEGIN TRY  
        DECLARE @TranCount INT = @@TRANCOUNT;
        IF(@TranCount = 0)
        BEGIN
            BEGIN TRANSACTION  
        END
	   UPDATE tartikel SET tartikel.dZulaufVerfuegbarAm = #TempResult.dLieferdatum 
		  FROM tArtikel 
		  JOIN #TempResult ON #TempResult.kArtikel = tArtikel.kArtikel
	   
	   SET @retry = 0;
        IF(@TranCount = 0)
        BEGIN           
            COMMIT TRANSACTION      
        END
    END TRY       
    BEGIN CATCH           
        IF(ERROR_NUMBER() = 1205 AND @TranCount = 0 AND XACT_STATE() &lt;&gt; 0)           
        BEGIN              
            SET @retry = @retry - 1;               
            ROLLBACK       
        END          
        ELSE          
        BEGIN              
            SET @retry = 0;               
            THROW;           
        END      
    END CATCH
END</code></pre>
</body>
</html>
