<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auslieferung.spLieferantenbestellung_ZusatzpositionenErstellen</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; }
        h1 { color: #333; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Auslieferung.spLieferantenbestellung_ZusatzpositionenErstellen</h1>
    <p><strong>Description:</strong> Keine Beschreibung hinterlegt.</p>
    <p><strong>Long Description:</strong> Keine ausf√ºhrliche Beschreibung hinterlegt.</p>
    <p><strong>Created At:</strong> 2024-01-12 03:32:03</p>
    <p><strong>Updated At:</strong> 2024-01-12 03:32:03</p>
    <h2>Code:</h2>
    <pre><code>CREATE PROCEDURE [Auslieferung].[spLieferantenbestellung_ZusatzpositionenErstellen]
-- M&#246;gliche Fehler:
-- Diese SP ist fehlerfrei
--
-- Transaction-Handling: siehe https://msdn.microsoft.com/en-us/library/ms188378.aspx
--
@kLieferantenbestellung AS INT

AS  
SET NOCOUNT ON;
SET ANSI_NULLS ON;
SET ANSI_NULL_DFLT_ON ON;
SET ANSI_PADDING ON;
SET CONCAT_NULL_YIELDS_NULL ON;
SET XACT_ABORT OFF;

DECLARE @TranCounter INT;
SET @TranCounter = @@TRANCOUNT;
IF @TranCounter &gt; 0
    SAVE TRANSACTION spLB_Zusatzpositionen
ELSE
    BEGIN TRANSACTION;

BEGIN TRY
    DECLARE @fUstMax DECIMAL(25,13);
    DECLARE @fEKGesamt DECIMAL(25,13);
    DECLARE @fRabatt DECIMAL(25,13);
    DECLARE @fMindestbestellwert DECIMAL(25,13);
    DECLARE @fMindermengenzuschlag DECIMAL(25,13);
    DECLARE @fFrachtkosten DECIMAL(25,13);
    DECLARE @fVersandfreiAb DECIMAL(25,13);
    DECLARE @kLieferant INT;
    DECLARE @cWaehrung NVARCHAR (MAX);
    DECLARE @cNameLieferant NVARCHAR (MAX);

    SELECT
	   @kLieferant = dbo.tLieferantenBestellung.kLieferant,
	   @cWaehrung = ISNULL(dbo.tWaehrung.cName, dbo.tLieferant.cWaehrungISO),
	   @cNameLieferant = dbo.tlieferant.cFirma,
	   @fMindestbestellwert = ISNULL(dbo.tlieferant.fMindestbestellwert, 0.0),
	   @fMindermengenzuschlag = ISNULL(dbo.tlieferant.fMindermengenzuschlag, 0.0),
	   @fFrachtkosten = ISNULL(dbo.tlieferant.fFrachtkosten, 0.0),
	   @fVersandfreiAb = ISNULL(dbo.tlieferant.fVersandfreiAb, 0.0)	   
    FROM
	   dbo.tLieferantenBestellung
    JOIN
	   dbo.tLieferant ON dbo.tLieferant.kLieferant = dbo.tLieferantenBestellung.kLieferant
    LEFT JOIN
	   dbo.tWaehrung ON dbo.tWaehrung.cEAMapping = dbo.tLieferant.cWaehrungISO
    WHERE
	   dbo.tLieferantenBestellung.kLieferantenBestellung = @kLieferantenbestellung

    -- Alle alten Sonderpositionen l&#246;schen
    DELETE FROM 
	   dbo.tLieferantenBestellungPos
    WHERE 
	   dbo.tLieferantenBestellungPos.kLieferantenBestellung = @kLieferantenbestellung
	   AND dbo.tLieferantenBestellungPos.nPosTyp IN (6, 10, 11); -- Versandzuschlag, Rabatt, Mindermengenzuschlag

    -- Summen berechnen
    SELECT 
	   @fUstMax = MAX(dbo.tLieferantenBestellungPos.fUST),
	   @fEKGesamt = SUM(dbo.tLieferantenBestellungPos.fEKNetto * dbo.tLieferantenBestellungPos.fMenge)
    FROM 
	   dbo.tLieferantenBestellungPos 
    WHERE 
	   dbo.tLieferantenBestellungPos.kLieferantenBestellung = @kLieferantenbestellung
	   AND NOT (dbo.tLieferantenBestellungPos.nPosTyp IN (6, 10, 11)); -- Versandzuschlag, Rabatt, Mindermengenzuschlag

    -- Neuen Rabatt eintragen
    SET @fRabatt = NULL;
    SELECT TOP(1)
	   @fRabatt = dbo.tLieferantRabattStaffel.fRabatt
    FROM
	   dbo.tLieferantRabattStaffel 
    WHERE
	   dbo.tLieferantRabattStaffel.kLieferant = @kLieferant 
	   AND dbo.tLieferantRabattStaffel.fAb &lt;= @fEKGesamt
    ORDER BY
	   dbo.tLieferantRabattStaffel.fAb DESC;

    IF (@fRabatt IS NOT NULL) 
    BEGIN
	   INSERT INTO dbo.tLieferantenBestellungPos
	   (
	       kLieferantenBestellung,
	       kArtikel,
	       cName,
	       fMenge,
		   fMengeGeliefert,
	       cHinweis,
	       fEKNetto,
	       nPosTyp,
	       cNameLieferant,
	       nSort
	   )
	   VALUES
	   (
	       @kLieferantenbestellung, -- kLieferantenBestellung - int
	       0, -- kArtikel - int
	       &#39;Rabattstaffel&#39;, -- cName - varchar
	       1.0, -- fMenge - decimal
		   0, -- fMengeGeliefert - decimal
	       &#39;Rabatt: &#39; + CAST(CAST(@fRabatt AS DECIMAL(28,2)) AS NVARCHAR(80)) + &#39;% von &#39; + CAST(CAST(@fEKGesamt AS DECIMAL(28,2)) AS NVARCHAR(80)) + &#39; &#39; + @cWaehrung, -- cHinweis - varchar
	       -((@fEKGesamt / 100.0) * @fRabatt), -- fEKNetto - decimal
	       10, -- nPosTyp - int
	       @cNameLieferant, -- cNameLieferant - varchar
	       (
			 SELECT 
				MAX(ISNULL(nSort, 0)) + 1
			 FROM 
				dbo.tLieferantenBestellungPos 
			 WHERE 
				dbo.tLieferantenBestellungPos.kLieferantenBestellung = @kLieferantenBestellung
		  ) -- nSort - int
	   )
    END

    -- Neuer Mindermengenzuschlag
    IF ((@fEKGesamt &lt; @fMindestbestellwert) AND (@fMindermengenzuschlag &gt; 0.0))
    BEGIN
	   INSERT INTO dbo.tLieferantenBestellungPos
	   (
	       kLieferantenBestellung,
	       kArtikel,
	       cName,
		  fUST,
	       fMenge,
		   fMengeGeliefert,
	       fEKNetto,
	       nPosTyp,
	       cNameLieferant,
	       nSort
	   )
	   VALUES
	   (
	       @kLieferantenbestellung, -- kLieferantenBestellung - int
	       0, -- kArtikel - int
	       &#39;Mindermengenzuschlag&#39;, -- cName - varchar
		  @fUstMax,
	       1.0, -- fMenge - decimal
		   0, -- fMengeGeliefert - decimal
	       @fMindermengenzuschlag, -- fEKNetto - decimal
	       11, -- nPosTyp - int
	       @cNameLieferant, -- cNameLieferant - varchar
	       (
			 SELECT 
				MAX(ISNULL(nSort, 0)) + 1
			 FROM 
				dbo.tLieferantenBestellungPos 
			 WHERE 
				dbo.tLieferantenBestellungPos.kLieferantenBestellung = @kLieferantenBestellung
		  ) -- nSort - int
	   ) 
    END

    IF ((@fFrachtkosten &gt; 0.0) AND ((@fEKGesamt &lt; @fVersandfreiAb) OR (@fVersandfreiAb = 0.0)))
    BEGIN
	   INSERT INTO dbo.tLieferantenBestellungPos
	   (
	       kLieferantenBestellung,
	       kArtikel,
	       cName,
		  fUST,
	       fMenge,
		   fMengeGeliefert,
	       fEKNetto,
	       nPosTyp,
	       cNameLieferant,
	       nSort
	   )
	   VALUES
	   (
	       @kLieferantenbestellung, -- kLieferantenBestellung - int
	       0, -- kArtikel - int
	       &#39;Frachtkosten&#39;, -- cName - varchar
		  @fUstMax,
	       1.0, -- fMenge - decimal
		   0, -- fMengeGeliefert - decimal
	       @fFrachtkosten, -- fEKNetto - decimal
	       6, -- nPosTyp - int
	       @cNameLieferant, -- cNameLieferant - varchar
	       (
			 SELECT 
				MAX(ISNULL(nSort, 0)) + 1
			 FROM 
				dbo.tLieferantenBestellungPos 
			 WHERE 
				dbo.tLieferantenBestellungPos.kLieferantenBestellung = @kLieferantenBestellung
		  ) -- nSort - int
	   )
    END
    IF @TranCounter = 0 
	   COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    IF @TranCounter = 0
	BEGIN
		IF @@TRANCOUNT &gt; 0 ROLLBACK TRANSACTION;
	END
    ELSE
	BEGIN
		IF XACT_STATE() &lt;&gt; -1
		BEGIN
			IF @@TRANCOUNT &gt; 0 ROLLBACK TRANSACTION spLB_Zusatzpositionen;
		END
	END

    DECLARE @ErrorMessage NVARCHAR(MAX);
    DECLARE @ErrorSeverity INT;
    DECLARE @ErrorState INT;

    SELECT @ErrorMessage = ERROR_MESSAGE();
    SELECT @ErrorSeverity = ERROR_SEVERITY();
    SELECT @ErrorState = ERROR_STATE();

    RAISERROR (@ErrorMessage, -- Message text.
               @ErrorSeverity, -- Severity.
               @ErrorState -- State.
              );
END CATCH</code></pre>
</body>
</html>
