<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Using the Geometry API for Simulating Diffraction and Transmission</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="akdoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Wwise SDK 2023.1.0 - Windows
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Using the Geometry API for Simulating Diffraction and Transmission </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="spatial_audio_apigeometry_diffract_intro"></a>
Introduction</h1>
<p>The geometry passed to Wwise Spatial Audio may be used to simulate diffraction and transmission of sound. As such, it can completely replace your game engine's raycasting methods for computing obstruction.</p>
<p>When an emitter is hidden from a listener by an object, Spatial Audio computes paths along its edges and, if some are found, computes the diffraction coefficient resulting from the sound bending around these edges. The apparent angle of incidence of the emitter is modified accordingly, and the diffraction value is sent to Wwise where you may control how it ultimately affects the sound. Typically, diffraction results in low-pass filtering.</p>
<p>Additionally, Spatial Audio computes sound paths going through geometry. Sound transmitting though an obstacle has a transmission loss coefficient applied to it, resulting from the surface properties assigned to the geometry via the API. Typically, transmission loss is modeled with a low-pass filter and a volume attenuation.</p>
<p>The image below is a screenshot of the Game Object 3D Viewer in Wwise. It shows a sound with a diffraction path, diffracting around the edges of a thin wall, and a transmission path with a transmission loss of 100%.</p>
<div class="image">
<img src="diffraction.png" alt=""/>
</div>
<table border="0" cellspacing="0" cellpadding="2">
<tr>
<td valign="top"><img src="images/Warning.gif" alt="" class="inline"/></td><td><b>Warning:</b> Geometric diffraction and transmission can be used to entirely replace your game engine's raycasting method for computing obstruction, however the performance cost grows with the complexity of the geometry. Geometry passed to Spatial Audio should be kept as simple as possible. Also, it is good to use the efficient Rooms and Portals abstraction (see <a class="el" href="using_rooms_and_portals.html">Rooms and Portals</a>) in conjunction with Geometric Diffraction in order to reduce the computational complexity of the latter. </td></tr>
</table>
<p>Geometric diffraction can be used to affect the direct sound propagation path between the emitter and listener, but also the path of its early reflections, when used in conjunction with Reflect.</p>
<h1><a class="anchor" id="spatial_audio_apigeometry_diffract_geometry_settings"></a>
Setting Up Geometry for Diffraction</h1>
<p>Each geometry set that is passed to Spatial Audio needs to say explicitly whether it should be considered for calculating diffraction paths. This is done via the <code><a class="el" href="struct_ak_geometry_params_a9ae54ac73dcb4426a1905fbd3c511ca0.html#a9ae54ac73dcb4426a1905fbd3c511ca0" title="Switch to enable or disable geometric diffraction for this Geometry.">AkGeometryParams::EnableDiffraction</a></code> flag. This flag enables generation of edge data that is necessary for diffraction calculations, and is used for both geometric diffraction on the direct path and for diffraction of reflections.</p>
<p>Also, consider whether or not you want the boundary edges of a mesh to be able to diffract sound. For a given mesh, a boundary edge is defined as an edge that is connected to only one triangle and, therefore, exists on the boundary of the manifold. The complexity of the diffraction calculation increases with the number of edges, so the option should be disabled if your mesh contains boundary edges that should not diffract sound.</p>
<p>Finally, note that acoustic textures assigned to acoustic surfaces do not have any effect on diffraction because edge materials don't absorb energy. Edges simply bend sound.</p>
<h1><a class="anchor" id="spatial_audio_apigeometry_diffract_geometry_settings_transmission"></a>
Setting Up Geometry for Transmission</h1>
<p>There are no additional steps required to set up geometry for sound transmission, however it may be desirable to adjust the transmission loss coefficient for various geometry types. For example, a concrete structure is likely to block almost all sound transmission, whereas geometry composed of plywood may block significantly less sound.</p>
<p>Each <code><a class="el" href="struct_ak_triangle.html" title="Triangle for a spatial audio mesh.">AkTriangle</a></code> in the <code><a class="el" href="struct_ak_geometry_params_ade39cd486dd1a534e9e97e80579fc72f.html#ade39cd486dd1a534e9e97e80579fc72f">AkGeometryParams::Triangles</a></code> array contains <code><a class="el" href="struct_ak_triangle_aefb228938046af58e01307605f391171.html#aefb228938046af58e01307605f391171">AkTriangle::surface</a></code>, an index into the <code><a class="el" href="struct_ak_geometry_params_a730165529c48be9f4e3371b9f9c25a4e.html#a730165529c48be9f4e3371b9f9c25a4e">AkGeometryParams::Surfaces</a></code> array. The <code><a class="el" href="struct_ak_acoustic_surface_ab0ec8a6eee25b28b4f8b9e91dbff17da.html#ab0ec8a6eee25b28b4f8b9e91dbff17da">AkAcousticSurface::transmissionLoss</a></code> field describes how much transmission loss to apply to a sound transmitting though a triangle that references it. It is expressed as a value between 0 and 1. The transmission loss is converted to a percentage and then used to evaluate Wwise curves. The final volume attenuation and filter value applied to a sound with a given transmission loss will depend on the curves defined in the project. By default, the project occlusion curve is used. Custom transmission curves can be created in the Attenuation ShareSet added to the sound. Transmission loss may also be applied as a built-in parameter and can be mapped to an RTPC.</p>
<h1><a class="anchor" id="spatial_audio_apigeometry_diffract_direct"></a>
Geometric Diffraction of the Direct Path</h1>
<p>Refer to the Geometric Diffraction demo and its code in the <a class="el" href="soundengine_integration_samplecode.html">Integration Demo Sample</a> (in <em>SDK/samples/IntegrationDemo</em>) for an example of using geometry for the purpose of geometric diffraction of the direct path. Look for Spatial Audio Demos &gt; Geometry Demo.</p>
<h2><a class="anchor" id="spatial_audio_apigeometry_diffract_direct_api"></a>
Setting up a Sound for Diffraction and Transmission</h2>
<p>In the Positioning tab in the Wwise Authoring tool, ensure that <b>Enable Diffraction and Transmission</b> is checked. This box enables Spatial Audio features related to diffraction and transmission, including:</p>
<ul>
<li>Computation of the diffracted path of the sound through geometry and/or portals, if applicable. The path calculation is performed by Spatial Audio on each game object that is currently playing a sound with diffraction and transmission enabled. If multiple diffraction-enabled sounds are playing on the same game object, the path calculation is only performed once.</li>
<li>Computation of the transmission path of the sound, through geometry and/or between rooms. The final transmission loss coefficient is always taken as the largest transmission loss value encountered along the transmission path, whether it comes from a room's <code>AkRoomParams::transmissionLoss</code> or a triangle's associated <code>AkAcousticSurface::TransmissionLoss</code>.</li>
<li>Generation of virtual positions for diffraction paths, which are sent to the Sound Engine for rendering the sound, assuming Spatial Audio's initialization setting <code><a class="el" href="struct_ak_spatial_audio_init_settings_a7b44a84de6c25d0abe4004c1c264aa13.html#a7b44a84de6c25d0abe4004c1c264aa13" title="An emitter that is diffracted through a portal or around geometry will have its apparent or virtual p...">AkSpatialAudioInitSettings::bCalcEmitterVirtualPosition</a></code> is set.</li>
<li>Application of curves according to the diffraction coefficient and the transmission loss coefficient.</li>
</ul>
<p>By default, the project obstruction curves are used for diffraction and the project occlusion curves are used for transmission. If the game has also set an obstruction or occlusion value via <code><a class="el" href="namespace_a_k_1_1_sound_engine_a1b3e18a25b405e55ba82de9b70cd11ba.html#a1b3e18a25b405e55ba82de9b70cd11ba">AK::SoundEngine::SetObjectObstructionAndOcclusion</a></code>, the values will be added.</p>
<p>Custom curves for diffraction and transmission can be created by adding an Attenuation ShareSet to the sound. Use the Attenuation Editor to create custom curves on Volume, LPF and HPF and fine-tune them while monitoring. For more information, refer to the <a href="https://www.audiokinetic.com/library/edge/?source=Help&amp;id=applying_distance_based_attenuation" target="_blank">Applying Attenuation</a> section of the Wwise Help.</p>
<h2><a class="anchor" id="spatial_audio_apigeometry_diffract_direct_wwise"></a>
Direct Path Diffraction and Transmission in Wwise</h2>
<p>Diffraction and transmission may be observed in the Game Object 3D Viewer, provided the proper profiling settings and view options are set (see the following images).</p>
<p>The calculated diffraction factor on a path from emitter to listener is displayed for each diffracting edge. Built-in Game Parameter values may be profiled by adding the bound Game Parameter to the Game Sync Monitor, and Obstruction and Diffraction may be profiled in the Profiler's Obs/Occ tab.</p>
<p>The calculated transmission loss factor is displayed beside the corresponding transmission path in the Game Object 3D Viewer. If the source of the transmission loss is from geometry, a hit point is indicated, with the accompanying transmission loss percentage. If the source of the transmission loss is from a room, the transmission loss percentage is displayed with the text "(Room)" appended below.</p>
<div class="image">
<img src="profiler_settings.png" alt=""/>
</div>
<div class="image">
<img src="3dviewer_settings.png" alt=""/>
</div>
<p>Like with Portals, the Diffraction value is 0 when the emitter is in direct sight of the listener, and it begins to increase as the emitter penetrates the shadow zone (see <a class="el" href="spatial_audio_concepts.html#spatial_audio_concepts_diffraction">Diffraction</a>). Also, please refer to Rooms and Portals' <a class="el" href="spatial_audio_roomsportals_apioverview.html#spatial_audio_roomsportals_modelingsoundpropagationfromotherrooms_diffraction">Diffraction</a> for more details on shadow zone diffraction and for a discussion about using curves versus the Built-in Diffraction Game Parameter.</p>
<h2><a class="anchor" id="spatial_audio_apigeometry_diffract_direct_portals"></a>
Direct Path Diffraction Interaction with Spatial Audio Rooms and Portals</h2>
<p>With Spatial Audio Rooms and Portals (<a class="el" href="using_rooms_and_portals.html">Rooms and Portals</a>), Portals also model diffraction of direct sounds in adjacent rooms. The two systems complement each other in that no geometry-driven diffraction paths are searched for emitters that are not in the same room as the listener. Provided that Rooms and Portals are much more efficient to calculate than geometry, it is beneficial to use both systems together to reduce computational complexity.</p>
<h1><a class="anchor" id="spatial_audio_apigeometry_diffract_er"></a>
Geometric Diffraction of Early Reflections</h1>
<p>Refer to the Reflect Diffraction demo and its code in the <a class="el" href="soundengine_integration_samplecode.html">Integration Demo Sample</a> (in <em>SDK/samples/IntegrationDemo</em>) for an example of using geometry for the purpose of geometric diffraction of Early Reflections. Look for Spatial Audio Demos &gt; Reflect Demo.</p>
<p>As was noted above, early reflections may diffract off of edges, and Spatial Audio supports modeling this phenomenon when emitters are routed to Reflect.</p>
<p>Prior to explaining how to do it, we need to define view zone diffraction.</p>
<p>Consider the figure below. The emitter is in direct sight of the listener, but the listener is not hit by specular reflections. It is thus in the <b>view zone</b>. As was said in <a class="el" href="spatial_audio_concepts.html#spatial_audio_concepts_diffraction">Diffraction</a>, diffraction occurs in the view zone as well. However, in Wwise Spatial Audio, neither the Rooms and Portals or Geometric Diffraction of direct path models consider diffraction in the view zone, as it is negligible compared to the actual direct path. However, for reflections, view zone diffraction has a dramatic impact. Without diffraction, early reflections are heard in the reflection zone only, where they are purely specular. As soon as the listener enters the view zone, reflections become silent. With diffraction enabled, the edge contributes to diffract the reflected wave. Thus, the listener perceives the reflection, albeit with additional filtering and attenuation as they go around and away from the reflection zone.</p>
<div class="image">
<img src="reflection_diffraction_2.png" alt=""/>
</div>
<p>In the reflection zone, there is no diffracted path and, therefore, no diffraction value is calculated, because the specular reflection is assumed to take over. The calculated view zone diffraction of a given edge is 0% at the boundary between the reflection zone and the view zone, and 100% at the boundary between the view zone and the shadow zone.</p>
<p>With higher orders of early reflections, both view and shadow zone diffraction come into play.</p>
<h2><a class="anchor" id="spatial_audio_apigeometry_diffract_er_api"></a>
Enable Reflections on Applicable Sounds</h2>
<p>In the Wwise Authoring Tool, set the desired early reflections send to an aux bus containing Reflect for all sounds requiring reflections. Refer to <a class="el" href="spatial_audio_apigeometry_er.html#spatial_audio_wwiseprojectsetup">Wwise project setup</a> for more details. There is no specific setting needed to enable diffraction for the purpose of reflections' diffraction, apart from enabling diffraction on the geometry.</p>
<h2><a class="anchor" id="spatial_audio_apigeometry_diffract_er_reflect"></a>
Settings in Reflect</h2>
<p>Reflections that undergo diffraction effects will appear as image sources in Reflect. You may design the effect of diffraction on reflections with the three curves that depend on diffraction: Diffraction Attenuation, Diffraction LPF, and Diffraction HPF. See <a href="https://www.audiokinetic.com/library/edge/?source=Help&amp;id=wwise_reflect_plug_in_effect" target="_blank">Reflect's documentation</a> for more details.</p>
<h1><a class="anchor" id="spatial_audio_api_geometry_aware_rooms"></a>
Combining the Geometric APIs with Rooms and Portals</h1>
<p>Rooms and portals in Wwise Spatial Audio work in conjunction with the geometric APIs for reflection and diffraction. The rooms and portals network can be thought of a high level abstraction (or as a low level-of-detail version) of the surrounding geometry. With care, the combination of rooms and portals with level geometry can result in a acoustic simulation that is both detailed and efficient.</p>
<h2><a class="anchor" id="spatial_audio_api_geometry_aware_rooms_diffraction"></a>
Geometric Diffraction Through Portals</h2>
<p>In the case where an emitter (assuming it is playing a sound that has been set up correctly for geometric diffraction, see <a class="el" href="spatial_audio_apigeometry_diffract.html#spatial_audio_apigeometry_diffract_direct_api">Setting up a Sound for Diffraction and Transmission</a>), is not in the same room as the listener, the geometric path is calculated as follows:</p><ul>
<li>The sound propagation paths from the emitter to the listener are calculated using the rooms and portals network.</li>
<li>For each path, the segment of the path between the emitter and the portal closest to the emitter is calculated using the geometric diffraction algorithm, as if the portal were the listener. Unless the emitter is directly behind a single portal from the perspective of the listener, only one geometric path is calculated (the shortest one found). Calculating additional paths between the emitter and the portal would not result in unique virtual positions, and is therefore unnecessary.</li>
<li>Path segments that are between two portals are also calculated using geometric diffraction if there is no direct line of sight between the portals. These calculations are done each time geometry and/or portals are added to or removed from the scene, and reused when required. In most cases, only the shortest path between the two portals is used. The exception being when the listener is directly behind one of the portals, in which case multiple paths are used to avoid discontinuities should the listener transition through the portal.</li>
<li>For each path, the segment of the path between the listener and the portal closest to the listener is calculated using the geometric diffraction algorithm, as if the portal were the emitter.</li>
<li>The resultant paths are taken as the combination of the above paths, branching and appending paths together where necessary.</li>
</ul>
<h2><a class="anchor" id="spatial_audio_api_geometry_aware_rooms_reflections"></a>
Reflections Through Portals</h2>
<p>Reflections can pass through portals and can reflect off of walls on either or both sides of the portal. Reflections can pass through more than one portal, possibly reflecting on surfaces between them if the reflection order is high enough (refer to <code><a class="el" href="struct_ak_spatial_audio_init_settings_a346377be1b9f6905fb2d8d3e1540eb39.html#a346377be1b9f6905fb2d8d3e1540eb39" title="Maximum reflection order [1, 4] - the number of &#39;bounces&#39; in a reflection path. A high reflection ord...">AkSpatialAudioInitSettings::uMaxReflectionOrder</a></code>). To ensure smooth reflections through portals, we recommend that you set <a class="el" href="struct_ak_spatial_audio_init_settings_a245b315e0cca157bdbef7cde581e8561.html#a245b315e0cca157bdbef7cde581e8561">AkSpatialAudioInitSettings::uDiffractionOnReflectionsOrder</a> to at least 2, but be aware that increasing this setting also increases CPU usage.</p>
<p>Because the portal itself describes an acoustic opening, it is not necessary to also "cut holes" in the triangle geometry to allow a sound to pass through, which would greatly increase the number of triangles. A portal box represents negative space, so remember that any geometry that intersects a portal is effectively ignored, for example in a room where the geometry is described by a box, with two triangles for each of the six sides. To ensure that sound can propagate outside the box, add a portal that intersects one of the walls along the portal's z-axis.</p>
<table border="0" cellspacing="0" cellpadding="2">
<tr>
<td valign="top"><img src="images/Warning.gif" alt="" class="inline"/></td><td><b>Warning:</b> For reflections to be accurately calculated on each side of a portal, set <code><a class="el" href="struct_ak_geometry_instance_params_aea389b1649781232851f7410554dd5f3.html#aea389b1649781232851f7410554dd5f3">AkGeometryInstanceParams::RoomID</a></code> to an invalid <a class="el" href="struct_ak_room_i_d.html">AkRoomID</a>. Unlike diffraction, reflection paths through portals are not calculated independently for each room and then later combined. Instead, reflections are calculated exactly as if the emitter and listener were in the same room, and the portal is treated as a hole in the geometry. </td></tr>
</table>
<h2><a class="anchor" id="spatial_audio_api_geometry_aware_rooms_portal_placement"></a>
Tips for Orienting Portals Between Rooms with Geometry</h2>
<p>The following image shows an example of a correctly oriented portal.</p>
<div class="image">
<img src="SpatialAudio_PortalPlacement.png" alt=""/>
</div>
<table border="1" cellspacing="0" cellpadding="1">
<tr>
<td><div class="image">
<img src="Callout1.png" alt=""/>
</div>
 </td><td><ul>
<li>
Geometry cut-outs allow reflection and diffraction paths to pass through the portal. </li>
<li>
A rectangular opening is subtracted from any geometry overlapped by the portal. </li>
<li>
Geometry cut-outs are drawn in the Game Object 3D Viewer with a dark green outline. </li>
<li>
For correct cut-out detection, the planes intersected by the portal must be non-intersecting (but not necessarily parallel), and they both must span the entire width (X) and height (Y) of the portal. </li>
</ul>
</td></tr>
<tr>
<td><div class="image">
<img src="Callout2.png" alt=""/>
</div>
 </td><td><ul>
<li>
A gap is permitted between the two planes, as well as between the two rooms joined by the portal. However, a game object is only permitted to enter a portal if it was previously in one of the adjoining rooms.  </li>
<li>
When a game object is transitioning through a portal, the room containment result passed to <a class="el" href="namespace_a_k_1_1_spatial_audio_a3f080206f12c04b3464838cb18c43f4e.html#a3f080206f12c04b3464838cb18c43f4e">AK::SpatialAudio::SetGameObjectInRoom</a> is used only as a hint. The exact room is determined by projecting the game object's position onto the portal's Z-axis, and then testing if the game object is in the front-half or back-half of the portal, corresponding to the front and back rooms respectively. </li>
<li>
The portal does not need to be perfectly aligned and centered between the two rooms. </li>
<li>
The transition point between two rooms is the center of the cut-out. When there is a gap between the two planes, the transition point is the center of the area between the two cut-outs. </li>
</ul>
<br  />
  </td></tr>
<tr>
<td><div class="image">
<img src="Callout3.png" alt=""/>
</div>
 </td><td><ul>
<li>
Ensure that a portal is deep enough along the Z-axis to allow for a smooth transition between two rooms. </li>
<li>
Abrupt transitions between two rooms can often be resolved by lengthening the portal along the Z-axis. </li>
</ul>
</td></tr>
</table>
<h2><a class="anchor" id="spatial_audio_api_geometry_aware_rooms_tagging_rooms"></a>
Tagging Geometry for Specific Rooms (Diffraction Only).</h2>
<table border="0" cellspacing="0" cellpadding="2">
<tr>
<td valign="top"><img src="images/Warning.gif" alt="" class="inline"/></td><td><b>Warning:</b> <code><a class="el" href="struct_ak_geometry_instance_params_aea389b1649781232851f7410554dd5f3.html#aea389b1649781232851f7410554dd5f3">AkGeometryInstanceParams::RoomID</a></code> is deprecated and the parameter will be removed in a future version. We recommend that you do not use RoomID, and instead leave it set to the default value (-1). </td></tr>
</table>
<p>As an optimization, assign <code><a class="el" href="struct_ak_geometry_instance_params_aea389b1649781232851f7410554dd5f3.html#aea389b1649781232851f7410554dd5f3">AkGeometryInstanceParams::RoomID</a></code> if all of the following conditions apply:</p><ul>
<li>Geometry is physically located in one room exclusively.</li>
<li>Portals are used primarily for diffraction and sound propagation of reverb.</li>
<li>Having accurate reflections pass through portals is not required.</li>
<li>The Room referenced by <code><a class="el" href="struct_ak_geometry_instance_params_aea389b1649781232851f7410554dd5f3.html#aea389b1649781232851f7410554dd5f3">AkGeometryInstanceParams::RoomID</a></code> is not a Reverb Zone, nor is it a parent room of a Reverb Zone. In this case, <code><a class="el" href="struct_ak_geometry_instance_params_aea389b1649781232851f7410554dd5f3.html#aea389b1649781232851f7410554dd5f3">AkGeometryInstanceParams::RoomID</a></code> is ignored. For more information about Reverb Zones, refer to <a class="el" href="spatial_audio_roomsportals_reverbzones.html">Using Reverb Zones</a>.</li>
</ul>
<p>To limit the search space for ray-triangle intersection tests, you can manually assign geometry to specific rooms. To do so, set <code><a class="el" href="struct_ak_geometry_instance_params_aea389b1649781232851f7410554dd5f3.html#aea389b1649781232851f7410554dd5f3">AkGeometryInstanceParams::RoomID</a></code> to the ID of a particular room. This indicates to Spatial Audio that the Geometry Instance in that room is only visible from other rooms through portals and not directly. Because a single Geometry Instance can only be associated with one room ID, a room cannot have geometry that is visible in multiple rooms unless <a class="el" href="struct_ak_geometry_instance_params_aea389b1649781232851f7410554dd5f3.html#aea389b1649781232851f7410554dd5f3">AkGeometryInstanceParams::RoomID</a> is invalid. Also note that if any geometry set is associated with a particular room ID, then that room can no longer "see" geometry that is not explicitly associated with that room. After you assign a Geometry Instance to a room, Spatial Audio only looks for geometry that is specifically associated with that room ID when it simulates reflection and diffraction in that room. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</body>
</html>
